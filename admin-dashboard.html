<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Radiant Gigs</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- HTML -->
    <header>
        <div class="logo">
            <i class="fas fa-pencil-alt"></i>
            <h1>Radiant Gigs - Admin</h1>
        </div>
        <nav>
            <button class="btn btn-secondary" onclick="toggleSection('productsSection')" aria-label="View Products">Products</button>
            <button class="btn btn-secondary" onclick="toggleSection('usersSection')" aria-label="View Users">Users</button>
            <button class="btn btn-secondary" onclick="toggleSection('ordersSection')" aria-label="View Orders">
                Orders
                <span class="new-order-dot" style="display: none;"></span>
            </button>
            <button class="btn btn-secondary" onclick="toggleSection('categoriesSection')" aria-label="View Categories">Categories</button>
            <button class="btn btn-secondary" onclick="toggleSection('couponsSection')" aria-label="View Coupons">Coupons</button>
            <button class="btn btn-secondary" onclick="toggleSection('progressSection')" aria-label="View Progress">Progress</button>
            <button class="btn btn-primary" onclick="logout()" aria-label="Logout">Logout</button>
        </nav>
    </header>
    <main>
        <section id="productsSection">
            <h2>Products</h2>
            <button class="btn btn-primary add-button" onclick="showAddProductForm()" aria-label="Add Product">Add Product</button>
            <div class="sort-controls">
                <select id="sortProducts" aria-label="Sort products">
                    <option value="featured">Featured</option>
                    <option value="name-asc">Name (A-Z)</option>
                    <option value="name-desc">Name (Z-A)</option>
                    <option value="price-asc">Price (Low to High)</option>
                    <option value="price-desc">Price (High to Low)</option>
                </select>
                <select id="categoryFilter" aria-label="Filter by category" onchange="resetFilters(this.value)">
                    <option value="">All Categories</option>
                </select>
                <input type="text" id="searchProducts" placeholder="Search products..." aria-label="Search products">
            </div>
            <div class="product-grid" id="productList"></div>
            <form id="addProductForm" class="form" aria-label="Add Product Form">
                <h3>Add/Edit Product</h3>
                <input type="hidden" id="editProductId">
                <div class="form-group">
                    <label for="productName">Name</label>
                    <input type="text" id="productName" required aria-describedby="productNameError">
                    <span id="productNameError" class="error"></span>
                </div>
                <div class="form-group">
                    <label for="productCategory">Category</label>
                    <select id="productCategory" required aria-label="Product Category">
                        <option value="">Select Category</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="productPrice">Price</label>
                    <input type="number" id="productPrice" step="0.01" required aria-describedby="productPriceError">
                    <span id="productPriceError" class="error"></span>
                </div>
                <div class="form-group">
                    <label for="productDiscountedPrice">Discounted Price</label>
                    <input type="number" id="productDiscountedPrice" step="0.01" aria-describedby="productDiscountedPriceError">
                    <span id="productDiscountedPriceError" class="error"></span>
                </div>
                <div class="form-group">
                    <label for="productStock">Stock</label>
                    <input type="number" id="productStock" required aria-describedby="productStockError">
                    <span id="productStockError" class="error"></span>
                </div>
                <div class="form-group">
                    <label for="productDescription">Description</label>
                    <textarea id="productDescription" required aria-describedby="productDescriptionError"></textarea>
                    <span id="productDescriptionError" class="error"></span>
                </div>
                <div class="form-group">
                    <label for="productImages">Upload Images</label>
                    <input type="file" id="productImages" multiple accept="image/*" aria-describedby="productImagesError">
                    <div id="imagePreview" class="image-preview"></div>
                    <span id="productImagesError" class="error"></span>
                </div>
                <div class="form-group">
                    <label for="productFeatured">Featured</label>
                    <input type="checkbox" id="productFeatured" aria-label="Featured Product">
                </div>
                <div class="form-group">
                    <label for="productEnabled">Enabled</label>
                    <input type="checkbox" id="productEnabled" checked aria-label="Enable Product">
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary" aria-label="Save Product">Save</button>
                    <button type="button" class="btn btn-secondary" onclick="cancelAddProduct()" aria-label="Cancel">Cancel</button>
                </div>
            </form>
        </section>
        <section id="usersSection" class="hidden">
            <h2>Users</h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="userList"></tbody>
            </table>
        </section>
        <section id="ordersSection" class="hidden">
            <h2>Orders</h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>User</th>
                        <th>Date</th>
                        <th>Total</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="orderList"></tbody>
            </table>
        </section>
        <section id="categoriesSection">
            <h2>Categories</h2>
            <button class="btn btn-primary add-button" onclick="showAddCategoryForm()" aria-label="Add Category">Add Category</button>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="categoryList"></tbody>
            </table>
            <form id="addCategoryForm" class="form" aria-label="Add Category Form">
                <h3>Add/Edit Category</h3>
                <input type="hidden" id="editCategoryId">
                <div class="form-group">
                    <label for="categoryName">Category Name</label>
                    <input type="text" id="categoryName" required aria-describedby="categoryNameError">
                    <span id="categoryNameError" class="error"></span>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary" aria-label="Save Category">Save</button>
                    <button type="button" class="btn btn-secondary" onclick="cancelAddCategory()" aria-label="Cancel">Cancel</button>
                </div>
            </form>
        </section>
        <section id="couponsSection" class="hidden">
            <h2>Coupons</h2>
            <button class="btn btn-primary add-button" onclick="showAddCouponForm()" aria-label="Add Coupon">Add Coupon</button>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Discount (%)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="couponList"></tbody>
            </table>
            <form id="addCouponForm" class="form" aria-label="Add Coupon Form">
                <h3>Add/Edit Coupon</h3>
                <input type="hidden" id="editCouponId">
                <div class="form-group">
                    <label for="couponCode">Coupon Code</label>
                    <input type="text" id="couponCode" required aria-describedby="couponCodeError">
                    <span id="couponCodeError" class="error"></span>
                </div>
                <div class="form-group">
                    <label for="couponDiscount">Discount (%)</label>
                    <input type="number" id="couponDiscount" step="0.01" required aria-describedby="couponDiscountError">
                    <span id="couponDiscountError" class="error"></span>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary" aria-label="Save Coupon">Save</button>
                    <button type="button" class="btn btn-secondary" onclick="cancelAddCoupon()" aria-label="Cancel">Cancel</button>
                </div>
            </form>
        </section>
        <section id="progressSection" class="hidden">
            <h2>Website Progress</h2>
            <div class="sort-controls">
                <select id="progressTimeRange" aria-label="Select time range">
                    <option value="thisWeek">This Week</option>
                    <option value="thisMonth">This Month</option>
                    <option value="thisYear">This Year</option>
                    <option value="custom">Custom Range</option>
                </select>
                <div id="customDateRange" class="custom-date-range hidden">
                    <input type="date" id="customStartDate" aria-label="Start date">
                    <input type="date" id="customEndDate" aria-label="End date">
                </div>
            </div>
            <div class="metrics-grid">
                <div class="metric-card">
                    <i class="fas fa-rupee-sign metric-icon"></i>
                    <span class="metric-label">Total Sales</span>
                    <span id="total-sales" class="metric-value">₹0</span>
                </div>
                <div class="metric-card">
                    <i class="fas fa-users metric-icon"></i>
                    <span class="metric-label">Active Users</span>
                    <span id="active-users" class="metric-value">0</span>
                </div>
                <div class="metric-card">
                    <i class="fas fa-boxes metric-icon"></i>
                    <span class="metric-label">Inventory Stock</span>
                    <span id="inventory-stock" class="metric-value">0</span>
                </div>
                <div class="metric-card">
                    <i class="fas fa-exclamation-circle metric-icon"></i>
                    <span class="metric-label">Out of Stock</span>
                    <span id="out-of-stock" class="metric-value">0</span>
                </div>
                <div class="metric-card">
                    <i class="fas fa-list metric-icon"></i>
                    <span class="metric-label">Total Items Listed</span>
                    <span id="total-items-listed" class="metric-value">0</span>
                </div>
                <div class="metric-card">
                    <i class="fas fa-shopping-cart metric-icon"></i>
                    <span class="metric-label">Total Orders</span>
                    <span id="total-orders" class="metric-value">0</span>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>© 2025 Radiant Gigs. All rights reserved.</p>
    </footer>
    <div id="notification" class="notification"></div>
    <div id="orderDetailsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-modal" onclick="closeOrderDetails()" aria-label="Close">×</span>
            <h3>Order Details</h3>
            <div id="orderDetailsContent"></div>
        </div>
    </div>

    <!-- CSS -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        body {
            background: #1a1a2d;
            color: #fff;
        }
        .btn {
            padding: 10px 20px;
            border-radius: 25px;
            border: none;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
        }
        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(57, 255, 20, 0.5);
        }
        .btn-primary {
            background: #39ff14;
            color: #1a1a2d;
        }
        .btn-secondary {
            background: #00ddeb;
            color: #fff;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        @keyframes neonGlow {
            0% { box-shadow: 0 0 5px rgba(57, 255, 20, 0.5); }
            50% { box-shadow: 0 0 15px rgba(57, 255, 20, 0.8), 0 0 20px rgba(0, 221, 235, 0.5); }
            100% { box-shadow: 0 0 5px rgba(57, 255, 20, 0.5); }
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        header {
            background: linear-gradient(135deg, #6b48ff, #00ddeb);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logo i {
            background: #39ff14;
            color: #1a1a2d;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .logo h1 {
            font-size: 28px;
            margin: 0;
        }
        header nav {
            display: flex;
            gap: 10px;
        }
        main {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        section {
            background: #2a2a3d;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.5s ease-in;
            position: relative;
        }
        section.hidden {
            display: none;
        }
        h2 {
            font-size: 28px;
            margin-bottom: 20px;
        }
        .sort-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        .sort-controls select,
        .sort-controls input[type="date"] {
            flex: 1;
            min-width: 150px;
            padding: 12px;
            border: 2px solid transparent;
            border-radius: 10px;
            font-size: 14px;
            color: #1a1a2d;
            background: #fff;
            background-clip: padding-box;
            transition: border 0.3s, box-shadow 0.3s;
        }
        .sort-controls select:focus,
        .sort-controls input[type="date"]:focus {
            outline: none;
            border: 2px solid #39ff14;
            box-shadow: 0 0 8px rgba(57, 255, 20, 0.5);
        }
        .custom-date-range {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .custom-date-range.hidden {
            display: none;
        }
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
        }
        .product-card {
            background: #1a1a2d;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .product-card img {
            width: 100%;
            height: 200px;
            object-fit: contain;
            border-radius: 5px;
            margin-bottom: 10px;
            background: #fff;
        }
        .product-card h3 {
            font-size: 16px;
            color: #00ddeb;
            margin-bottom: 8px;
        }
        .product-card p {
            font-size: 12px;
            color: #e0e0e0;
            margin-bottom: 8px;
        }
        .product-card .btn-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        .product-card .btn {
            margin: 0;
            padding: 8px 15px;
            font-size: 12px;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #3a3a4d;
        }
        .data-table th {
            background: #1a1a2d;
            color: #00ddeb;
        }
        .data-table td {
            color: #e0e0e0;
        }
        .data-table tr:hover {
            background: #3a3a4d;
        }
        .new-order-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #39ff14;
            border-radius: 50%;
            position: absolute;
            top: 5px;
            right: 5px;
            box-shadow: 0 0 5px rgba(57, 255, 20, 0.8);
            animation: pulse 1.5s infinite;
        }
        .form {
            background: #1a1a2d;
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        .add-button {
            margin-bottom: 15px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            color: #e0e0e0;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            color: #fff;
            background: #2a2a3d;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .form-group .error {
            color: #39ff14;
            font-size: 12px;
            display: block;
            margin-top: 5px;
        }
        .image-preview {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .image-preview img {
            max-width: 100px;
            max-height: 100px;
            object-fit: cover;
            border-radius: 5px;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 10px;
            color: #1a1a2d;
            display: none;
            z-index: 1000;
        }
        .notification.success {
            background: #00ddeb;
            box-shadow: 0 0 15px rgba(0, 221, 235, 0.5);
            animation: slideIn 0.3s ease-in;
        }
        .notification.error {
            background: #39ff14;
            box-shadow: 0 0 15px rgba(57, 255, 20, 0.5);
            animation: slideIn 0.3s ease-in;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: #2a2a3d;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-content h3 {
            margin-bottom: 20px;
            color: #00ddeb;
        }
        .modal-content p {
            margin-bottom: 10px;
            color: #e0e0e0;
        }
        .modal-content table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .modal-content table th,
        .modal-content table td {
            padding: 10px;
            border-bottom: 1px solid #3a3a4d;
            text-align: left;
        }
        .modal-content table th {
            background: #1a1a2d;
            color: #00ddeb;
        }
        .delivery-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(57, 255, 20, 0.3);
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease-out;
        }
        .delivery-card h4 {
            font-size: 18px;
            color: #00ddeb;
            margin-bottom: 10px;
        }
        .delivery-card p {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            color: #e0e0e0;
            font-size: 14px;
        }
        .delivery-card p i {
            color: #39ff14;
        }
        .close-modal {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
            color: #e0e0e0;
        }
        .close-modal:hover {
            color: #39ff14;
        }
        footer {
            background: #1a1a2d;
            padding: 15px;
            text-align: center;
            border-top: 1px solid #2a2a3d;
        }
        footer p {
            font-size: 14px;
            color: #e0e0e0;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            padding: 20px;
            background: rgba(42, 42, 61, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.4);
        }
        .metric-card {
            padding: 20px;
            background: linear-gradient(135deg, rgba(57, 255, 20, 0.1), rgba(0, 221, 235, 0.1));
            border: 2px solid transparent;
            border-radius: 12px;
            text-align: center;
            transition: transform 0.3s, border 0.3s;
            animation: neonGlow 2s infinite;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .metric-card:hover {
            transform: scale(1.05);
            border: 2px solid #39ff14;
        }
        .metric-icon {
            font-size: 24px;
            color: #00ddeb;
            margin-bottom: 10px;
        }
        .metric-label {
            font-size: 14px;
            color: #00ddeb;
            font-weight: 600;
            display: block;
            margin-bottom: 8px;
        }
        .metric-value {
            font-size: 20px;
            font-weight: 700;
            color: #39ff14;
            display: block;
        }
        @media (max-width: 1024px) {
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 15px;
            }
            header nav {
                flex-wrap: wrap;
                justify-content: center;
            }
            .sort-controls {
                flex-direction: column;
            }
            .product-grid {
                grid-template-columns: 1fr;
            }
            .data-table {
                font-size: 12px;
            }
            .data-table th,
            .data-table td {
                padding: 8px;
            }
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            .metric-card {
                width: 100%;
                max-width: 300px;
            }
            .metric-value {
                font-size: 18px;
            }
            .metric-label {
                font-size: 12px;
            }
            .metric-icon {
                font-size: 20px;
            }
        }
    </style>

    <!-- JavaScript -->
    <script>
        // Data Initialization
        let products, users, orders, categories, coupons, currentAdmin, lastLoadTime;
        function resetData() {
            try {
                // Helper function to safely parse localStorage
                function safeParse(key, defaultValue) {
                    const data = localStorage.getItem(key);
                    if (!data) return defaultValue;
                    try {
                        return JSON.parse(data);
                    } catch (e) {
                        console.error(`Failed to parse ${key} from localStorage:`, e);
                        return defaultValue;
                    }
                }

                // Initialize currentAdmin
                currentAdmin = safeParse('currentAdmin', null);

                // Initialize data with defaults if parsing fails
                products = safeParse('products', []);
                users = safeParse('users', []);
                orders = safeParse('orders', []);
                categories = safeParse('categories', ['Notebooks', 'Pens', 'Sketchbooks']);
                coupons = safeParse('coupons', [
                    { code: 'SAVE10', discount: 0.1 },
                    { code: 'SAVE20', discount: 0.2 }
                ]);

                // Normalize products
                products = products.map(p => ({
                    ...p,
                    featured: p.featured !== undefined ? p.featured : false,
                    images: Array.isArray(p.images) ? p.images : [],
                    enabled: p.enabled !== undefined ? p.enabled : true,
                    lastModified: p.lastModified || new Date().toISOString()
                }));

                // Normalize users
                users = users.map(u => ({
                    ...u,
                    status: u.status || 'active',
                    registeredAt: u.registeredAt || new Date().toISOString()
                }));

                // Normalize orders
                orders = orders.map(o => ({
                    ...o,
                    isNew: o.isNew !== undefined ? o.isNew : !o.date || new Date(o.date) > lastLoadTime
                }));

                lastLoadTime = new Date();
                saveData();
            } catch (e) {
                console.error('Failed to initialize data:', e);
                showNotification('Failed to initialize data. Please try clearing localStorage and refreshing.', 'error');
                currentAdmin = null;
                products = [];
                users = [];
                orders = [];
                categories = ['Notebooks', 'Pens', 'Sketchbooks'];
                coupons = [
                    { code: 'SAVE10', discount: 0.1 },
                    { code: 'SAVE20', discount: 0.2 }
                ];
                saveData();
            }
        }
        resetData();

        // Save Data
        function saveData() {
            try {
                localStorage.setItem('products', JSON.stringify(products));
                localStorage.setItem('users', JSON.stringify(users));
                localStorage.setItem('orders', JSON.stringify(orders));
                localStorage.setItem('categories', JSON.stringify(categories));
                localStorage.setItem('coupons', JSON.stringify(coupons));
                localStorage.setItem('currentAdmin', JSON.stringify(currentAdmin));
            } catch (e) {
                showNotification('Failed to save data: Storage limit reached', 'error');
                console.error('Failed to save data:', e);
            }
        }

        // Notification
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            notification.className = `notification ${type}`;
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        // Update Orders Button Dot
        function updateOrderButtonDot() {
            const hasNewOrders = orders.some(order => order.isNew === true);
            const dot = document.querySelector('.new-order-dot');
            dot.style.display = hasNewOrders ? 'inline-block' : 'none';
        }

        // Section Toggle
        function toggleSection(sectionId) {
            document.querySelectorAll('section').forEach(section => section.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
            document.getElementById('addProductForm').style.display = 'none';
            document.getElementById('addCategoryForm').style.display = 'none';
            document.getElementById('addCouponForm').style.display = 'none';
            if (sectionId === 'productsSection') loadProducts();
            else if (sectionId === 'usersSection') loadUsers();
            else if (sectionId === 'ordersSection') loadOrders();
            else if (sectionId === 'categoriesSection') loadCategories();
            else if (sectionId === 'couponsSection') loadCoupons();
            else if (sectionId === 'progressSection') loadProgress();
        }

        // Reset Filters
        function resetFilters(category) {
            if (category === '') {
                document.getElementById('searchProducts').value = '';
                document.getElementById('sortProducts').value = 'featured';
            }
            loadProducts();
        }

        // Progress Section
        function loadProgress() {
            try {
                const timeRange = document.getElementById('progressTimeRange').value;
                const now = new Date();
                let startDate, endDate;

                if (timeRange === 'thisWeek') {
                    const dayOfWeek = now.getDay();
                    const daysToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - daysToMonday);
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(now);
                } else if (timeRange === 'thisMonth') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now);
                } else if (timeRange === 'thisYear') {
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now);
                } else if (timeRange === 'custom') {
                    const startInput = document.getElementById('customStartDate').value;
                    const endInput = document.getElementById('customEndDate').value;
                    if (!startInput || !endInput) {
                        showNotification('Please select both start and end dates', 'error');
                        return;
                    }
                    startDate = new Date(startInput);
                    endDate = new Date(endInput);
                    endDate.setHours(23, 59, 59, 999); // Include entire end date
                    if (endDate < startDate) {
                        showNotification('End date must be after start date', 'error');
                        return;
                    }
                }

                // Total Sales
                const totalSales = orders
                    .filter(o => {
                        const orderDate = new Date(o.date);
                        return orderDate >= startDate && orderDate <= endDate;
                    })
                    .reduce((sum, o) => sum + (o.total || 0), 0);
                document.getElementById('total-sales').textContent = `₹${totalSales.toLocaleString('en-IN')}`;

                // Active Users
                const activeUsers = users.filter(u => u.status === 'active' && new Date(u.registeredAt) >= startDate && new Date(u.registeredAt) <= endDate).length;
                document.getElementById('active-users').textContent = activeUsers.toLocaleString();

                // Inventory Stock
                const inventoryStock = products.reduce((sum, p) => sum + (p.stock || 0), 0);
                document.getElementById('inventory-stock').textContent = inventoryStock.toLocaleString();

                // Out of Stock Products
                const outOfStock = products.filter(p => (p.stock || 0) === 0).length;
                document.getElementById('out-of-stock').textContent = outOfStock.toLocaleString();

                // Total Items Listed
                const totalItemsListed = products.length;
                document.getElementById('total-items-listed').textContent = totalItemsListed.toLocaleString();

                // Total Orders
                const totalOrders = orders.filter(o => {
                    const orderDate = new Date(o.date);
                    return orderDate >= startDate && orderDate <= endDate;
                }).length;
                document.getElementById('total-orders').textContent = totalOrders.toLocaleString();
            } catch (e) {
                console.error('Error loading progress:', e);
                showNotification('Error loading progress data', 'error');
            }
        }

        // Toggle Custom Date Range Visibility
        document.getElementById('progressTimeRange').addEventListener('change', function() {
            const customDateRange = document.getElementById('customDateRange');
            if (this.value === 'custom') {
                customDateRange.classList.remove('hidden');
            } else {
                customDateRange.classList.add('hidden');
                loadProgress(); // Load data immediately for non-custom ranges
            }
        });

        // Update Progress on Date Change
        document.getElementById('customStartDate').addEventListener('change', loadProgress);
        document.getElementById('customEndDate').addEventListener('change', loadProgress);

        // Products
        function loadProducts() {
            try {
                const sort = document.getElementById('sortProducts').value;
                const category = document.getElementById('categoryFilter').value;
                const search = document.getElementById('searchProducts').value.toLowerCase();
                const productList = document.getElementById('productList');
                const categoryFilter = document.getElementById('categoryFilter');
                const productCategory = document.getElementById('productCategory');

                if (!Array.isArray(products)) {
                    console.error('Products is not an array:', products);
                    productList.innerHTML = '<p>Error: Invalid product data</p>';
                    return;
                }

                let filteredProducts = products.filter(p => {
                    try {
                        return (p.name || '').toLowerCase().includes(search) &&
                               (category === '' || (p.category || '') === category);
                    } catch (e) {
                        console.error('Error filtering product:', p, e);
                        return false;
                    }
                });

                filteredProducts.sort((a, b) => {
                    if (sort === 'featured') {
                        if (a.featured && !b.featured) return -1;
                        if (!a.featured && b.featured) return 1;
                        return (a.name || '').localeCompare(b.name || '');
                    }
                    if (sort === 'name-asc') return (a.name || '').localeCompare(b.name || '');
                    if (sort === 'name-desc') return (b.name || '').localeCompare(a.name || '');
                    if (sort === 'price-asc') return (a.discountedPrice || a.mrpPrice || 0) - (b.discountedPrice || b.mrpPrice || 0);
                    if (sort === 'price-desc') return (b.discountedPrice || b.mrpPrice || 0) - (a.discountedPrice || a.mrpPrice || 0);
                    return 0;
                });

                productList.innerHTML = filteredProducts.length ? filteredProducts.map(p => {
                    try {
                        return `
                            <div class="product-card">
                                <img src="${(p.images && p.images[0]) || 'https://via.placeholder.com/300'}" alt="${p.name || 'Product'}">
                                <h3>${p.name || 'Unknown'}</h3>
                                <p>₹${((p.discountedPrice || p.mrpPrice || 0)).toFixed(2)}</p>
                                <p>Stock: ${p.stock !== undefined ? p.stock : 'Unknown'}</p>
                                <p>Enabled: ${p.enabled ? 'Yes' : 'No'}</p>
                                <p>Featured: ${p.featured ? 'Yes' : 'No'}</p>
                                <div class="btn-container">
                                    <button class="btn btn-primary" onclick="editProduct(${p.id})" aria-label="Edit ${p.name || 'product'}">Edit</button>
                                    <button class="btn btn-secondary" onclick="deleteProduct(${p.id})" aria-label="Delete ${p.name || 'product'}"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        `;
                    } catch (e) {
                        console.error('Error rendering product:', p, e);
                        return '';
                    }
                }).join('') : '<p>No products found</p>';

                categoryFilter.innerHTML = '<option value="">All Categories</option>' + categories.map(cat => `<option value="${cat}" ${cat === category ? 'selected' : ''}>${cat}</option>`).join('');
                productCategory.innerHTML = '<option value="">Select Category</option>' + categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            } catch (e) {
                console.error('Error loading products:', e);
                showNotification('Error loading products. Check console for details.', 'error');
                document.getElementById('productList').innerHTML = '<p>Error loading products</p>';
            }
        }

        function showAddProductForm() {
            const form = document.getElementById('addProductForm');
            form.style.display = form.style.display === 'block' ? 'none' : 'block';
            if (form.style.display === 'block') {
                document.getElementById('editProductId').value = '';
                document.getElementById('addProductForm').reset();
                document.getElementById('productEnabled').checked = true;
                document.getElementById('productFeatured').checked = false;
                document.getElementById('imagePreview').innerHTML = '';
                document.querySelectorAll('.form-group .error').forEach(error => error.textContent = '');
                form.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function cancelAddProduct() {
            document.getElementById('addProductForm').style.display = 'none';
            document.getElementById('addProductForm').reset();
            document.getElementById('imagePreview').innerHTML = '';
            document.querySelectorAll('.form-group .error').forEach(error => error.textContent = '');
        }

        document.getElementById('addProductForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const editId = document.getElementById('editProductId').value;
            const name = document.getElementById('productName').value.trim();
            const category = document.getElementById('productCategory').value;
            const price = parseFloat(document.getElementById('productPrice').value);
            const discountedPrice = parseFloat(document.getElementById('productDiscountedPrice').value) || null;
            const stock = parseInt(document.getElementById('productStock').value);
            const description = document.getElementById('productDescription').value.trim();
            const featured = document.getElementById('productFeatured').checked;
            const enabled = document.getElementById('productEnabled').checked;
            const imageFiles = document.getElementById('productImages').files;

            const nameError = document.getElementById('productNameError');
            const priceError = document.getElementById('productPriceError');
            const discountedPriceError = document.getElementById('productDiscountedPriceError');
            const stockError = document.getElementById('productStockError');
            const descriptionError = document.getElementById('productDescriptionError');
            const imageError = document.getElementById('productImagesError');

            document.querySelectorAll('.form-group .error').forEach(error => error.textContent = '');

            let hasError = false;
            if (name.length < 2) {
                nameError.textContent = 'Name must be at least 2 characters';
                hasError = true;
            }
            if (!category) {
                showNotification('Please select a category', 'error');
                hasError = true;
            }
            if (isNaN(price) || price <= 0) {
                priceError.textContent = 'Price must be greater than 0';
                hasError = true;
            }
            if (discountedPrice && (discountedPrice >= price || discountedPrice <= 0)) {
                discountedPriceError.textContent = 'Discounted price must be less than price and greater than 0';
                hasError = true;
            }
            if (isNaN(stock) || stock < 0) {
                stockError.textContent = 'Stock must be 0 or greater';
                hasError = true;
            }
            if (description.length < 10) {
                descriptionError.textContent = 'Description must be at least 10 characters';
                hasError = true;
            }
            if (imageFiles.length === 0 && editId === '') {
                imageError.textContent = 'At least one image is required';
                hasError = true;
            }

            if (hasError) {
                showNotification('Please fix the errors in the form', 'error');
                return;
            }

            const images = [];
            if (imageFiles.length > 0) {
                for (let file of imageFiles) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        images.push(e.target.result);
                        if (images.length === imageFiles.length) {
                            submitProduct(editId, name, category, price, discountedPrice, stock, description, images, featured, enabled);
                        }
                    };
                    reader.readAsDataURL(file);
                }
            } else {
                submitProduct(editId, name, category, price, discountedPrice, stock, description, [], featured, enabled);
            }
        });

        function submitProduct(editId, name, category, price, discountedPrice, stock, description, images, featured, enabled) {
            if (editId) {
                const product = products.find(p => p.id === parseInt(editId));
                if (product) {
                    product.name = name;
                    product.category = category;
                    product.mrpPrice = price;
                    product.discountedPrice = discountedPrice;
                    product.stock = stock;
                    product.description = description;
                    product.images = images.length > 0 ? images : product.images;
                    product.featured = featured;
                    product.enabled = enabled;
                    product.lastModified = new Date().toISOString();
                    showNotification('Product updated successfully', 'success');
                }
            } else {
                const product = {
                    id: products.length ? Math.max(...products.map(p => p.id)) + 1 : 1,
                    name,
                    category,
                    mrpPrice: price,
                    discountedPrice,
                    stock,
                    description,
                    images,
                    featured,
                    enabled,
                    lastModified: new Date().toISOString()
                };
                products.push(product);
                showNotification('Product added successfully', 'success');
            }
            saveData();
            loadProducts();
            cancelAddProduct();
        }

        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) {
                showNotification('Product not found', 'error');
                return;
            }
            document.getElementById('editProductId').value = product.id;
            document.getElementById('productName').value = product.name;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productPrice').value = product.mrpPrice;
            document.getElementById('productDiscountedPrice').value = product.discountedPrice || '';
            document.getElementById('productStock').value = product.stock;
            document.getElementById('productDescription').value = product.description;
            document.getElementById('productFeatured').checked = product.featured;
            document.getElementById('productEnabled').checked = product.enabled;
            document.getElementById('imagePreview').innerHTML = product.images.map(img => `<img src="${img}" alt="Product Image">`).join('');
            const form = document.getElementById('addProductForm');
            form.style.display = 'block';
            form.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function deleteProduct(id) {
            if (!confirm('Are you sure you want to delete this product?')) return;
            products = products.filter(p => p.id !== id);
            saveData();
            loadProducts();
            showNotification('Product deleted successfully', 'success');
        }

        // Image Preview
        document.getElementById('productImages').addEventListener('change', function(e) {
            const files = e.target.files;
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';
            for (let file of files) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.alt = 'Product Image Preview';
                    preview.appendChild(img);
                };
                reader.readAsDataURL(file);
            }
        });

        // Users
        function loadUsers() {
            try {
                const userList = document.getElementById('userList');
                userList.innerHTML = users.length ? users.map(u => `
                    <tr>
                        <td>${u.username}</td>
                        <td>${u.email}</td>
                        <td style="color:${u.status === 'active' ? '#39ff14' : '#ff4444'}">${u.status}</td>
                        <td>
                            <button class="btn btn-primary" onclick="toggleUserStatus('${u.email}')" aria-label="${u.status === 'active' ? 'Block' : 'Unblock'} ${u.username}">
                                ${u.status === 'active' ? 'Block' : 'Unblock'}
                            </button>
                        </td>
                    </tr>
                `).join('') : '<tr><td colspan="4">No users found</td></tr>';
            } catch (e) {
                console.error('Error loading users:', e);
                showNotification('Error loading users', 'error');
            }
        }

        function toggleUserStatus(email) {
            const user = users.find(u => u.email === email);
            if (!user) {
                showNotification('User not found', 'error');
                return;
            }
            user.status = user.status === 'active' ? 'blocked' : 'active';
            saveData();
            loadUsers();
            showNotification(`User ${user.status === 'active' ? 'unblocked' : 'blocked'} successfully`, 'success');
        }

        // Orders
        function loadOrders() {
            try {
                const orderList = document.getElementById('orderList');
                orders.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
                orderList.innerHTML = orders.length ? orders.map(o => `
                    <tr>
                        <td>${o.isNew ? '<span class="new-order-dot"></span>' : ''}${o.id}</td>
                        <td>${o.user || 'Unknown'}</td>
                        <td>${new Date(o.date || Date.now()).toLocaleDateString('en-IN')}</td>
                        <td>₹${(o.total || 0).toFixed(2)}</td>
                        <td style="color:${o.status === 'Processing' ? '#39ff14' : o.status === 'Shipped' ? '#00ddeb' : o.status === 'Delivered' ? '#00ffaa' : '#ff4444'}">${o.status || 'Unknown'}</td>
                        <td>
                            <button class="btn btn-primary" onclick="viewOrderDetails(${o.id})" aria-label="View order ${o.id}">View</button>
                            <select onchange="updateOrderStatus(${o.id}, this.value)" aria-label="Update status of order ${o.id}">
                                <option value="Processing" ${o.status === 'Processing' ? 'selected' : ''}>Processing</option>
                                <option value="Shipped" ${o.status === 'Shipped' ? 'selected' : ''}>Shipped</option>
                                <option value="Delivered" ${o.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                                <option value="Cancelled" ${o.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                            </select>
                        </td>
                    </tr>
                `).join('') : '<tr><td colspan="6">No orders found</td></tr>';

                // Mark all orders as viewed
                orders.forEach(order => {
                    if (order.isNew) order.isNew = false;
                });
                saveData();
                updateOrderButtonDot();
            } catch (e) {
                console.error('Error loading orders:', e);
                showNotification('Error loading orders', 'error');
            }
        }

        function placeOrder(user, items, total) {
            const order = {
                id: orders.length ? Math.max(...orders.map(o => o.id)) + 1 : 1,
                user,
                date: new Date().toISOString(),
                total,
                status: 'Processing',
                items,
                isNew: true
            };
            orders.push(order);
            saveData();
            loadOrders();
            updateOrderButtonDot();
            showNotification(`New order #${order.id} placed by ${user}`, 'success');
        }

        function viewOrderDetails(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) {
                showNotification('Order not found', 'error');
                return;
            }
            const content = document.getElementById('orderDetailsContent');
            const items = order.items || [];
            const itemDetails = items.map(item => {
                const product = products.find(p => p.id === item.id);
                const price = (product && (product.discountedPrice || product.mrpPrice)) || item.price || 0;
                const amount = price * (item.quantity || 0);
                return {
                    name: product ? product.name : `Unknown (ID: ${item.id})`,
                    quantity: item.quantity || 0,
                    price: price.toFixed(2),
                    amount: amount.toFixed(2)
                };
            });
            content.innerHTML = `
                <p><strong>Order ID:</strong> ${order.id}</p>
                <p><strong>User:</strong> ${order.user || 'Unknown'}</p>
                <p><strong>Date:</strong> ${new Date(order.date || Date.now()).toLocaleDateString('en-IN')}</p>
                ${order.coupon ? `<p><strong>Coupon:</strong> ${order.coupon}</p>` : ''}
                ${order.discountAmount ? `<p><strong>Discount:</strong> ₹${order.discountAmount.toFixed(2)}</p>` : ''}
                <p><strong>Total:</strong> ₹${(order.total || 0).toFixed(2)}</p>
                <p><strong>Status:</strong> ${order.status || 'Unknown'}</p>
                <div class="delivery-card">
                    <h4>Delivery Details</h4>
                    <p><i class="fas fa-user"></i> <strong>Name:</strong> ${order.deliveryDetails?.name || 'Not provided'}</p>
                    <p><i class="fas fa-phone"></i> <strong>Phone:</strong> ${order.deliveryDetails?.phone || 'Not provided'}</p>
                    <p><i class="fas fa-map-marker-alt"></i> <strong>Address:</strong> ${order.deliveryDetails?.address || 'Not provided'}</p>
                    ${order.deliveryDetails?.notes ? `<p><i class="fas fa-sticky-note"></i> <strong>Notes:</strong> ${order.deliveryDetails.notes}</p>` : ''}
                </div>
                <h4>Items:</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Product Name</th>
                            <th>Quantity</th>
                            <th>Price (₹)</th>
                            <th>Amount (₹)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemDetails.length ? itemDetails.map(item => `
                            <tr>
                                <td>${item.name}</td>
                                <td>${item.quantity}</td>
                                <td>${item.price}</td>
                                <td>${item.amount}</td>
                            </tr>
                        `).join('') : '<tr><td colspan="4">No items found</td></tr>'}
                    </tbody>
                </table>
            `;
            if (order.isNew) {
                order.isNew = false;
                saveData();
                loadOrders();
                updateOrderButtonDot();
            }
            document.getElementById('orderDetailsModal').style.display = 'flex';
        }

        function closeOrderDetails() {
            document.getElementById('orderDetailsModal').style.display = 'none';
            document.getElementById('orderDetailsContent').innerHTML = '';
        }

        function updateOrderStatus(orderId, status) {
            const order = orders.find(o => o.id === orderId);
            if (!order) {
                showNotification('Order not found', 'error');
                return;
            }
            if (order.status === 'Cancelled' || order.status === 'Delivered') {
                showNotification('Cannot change status of this order', 'error');
                loadOrders();
                return;
            }
            order.status = status;
            if (status === 'Cancelled' && order.items) {
                order.items.forEach(item => {
                    const product = products.find(p => p.id === item.id);
                    if (product) product.stock += item.quantity || 0;
                });
            }
            saveData();
            loadOrders();
            showNotification('Order status updated successfully', 'success');
        }

        // Categories
        function loadCategories() {
            try {
                const categoryList = document.getElementById('categoryList');
                categoryList.innerHTML = categories.length ? categories.map((cat, index) => `
                    <tr>
                        <td>${cat}</td>
                        <td>
                            <button class="btn btn-primary" onclick="editCategory(${index})" aria-label="Edit ${cat}">Edit</button>
                            <button class="btn btn-secondary" onclick="deleteCategory(${index})" aria-label="Delete ${cat}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('') : '<tr><td colspan="2">No categories found</td></tr>';
            } catch (e) {
                console.error('Error loading categories:', e);
                showNotification('Error loading categories', 'error');
            }
        }

        function showAddCategoryForm() {
            const form = document.getElementById('addCategoryForm');
            form.style.display = form.style.display === 'block' ? 'none' : 'block';
            if (form.style.display === 'block') {
                document.getElementById('editCategoryId').value = '';
                document.getElementById('addCategoryForm').reset();
                document.querySelectorAll('.form-group .error').forEach(error => error.textContent = '');
                form.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function cancelAddCategory() {
            document.getElementById('addCategoryForm').style.display = 'none';
            document.getElementById('addCategoryForm').reset();
            document.querySelectorAll('.form-group .error').forEach(error => error.textContent = '');
        }

        document.getElementById('addCategoryForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const editId = document.getElementById('editCategoryId').value;
            const name = document.getElementById('categoryName').value.trim();

            const nameError = document.getElementById('categoryNameError');
            nameError.textContent = '';

            if (name.length < 2) {
                nameError.textContent = 'Category name must be at least 2 characters';
                showNotification('Please fix the errors in the form', 'error');
                return;
            }

            if (categories.includes(name) && editId === '') {
                nameError.textContent = 'Category already exists';
                showNotification('Category already exists', 'error');
                return;
            }

            if (editId !== '') {
                const index = parseInt(editId);
                categories[index] = name;
                showNotification('Category updated successfully', 'success');
            } else {
                categories.push(name);
                showNotification('Category added successfully', 'success');
            }
            saveData();
            loadCategories();
            loadProducts();
            cancelAddCategory();
        });

        function editCategory(index) {
            document.getElementById('editCategoryId').value = index;
            document.getElementById('categoryName').value = categories[index];
            const form = document.getElementById('addCategoryForm');
            form.style.display = 'block';
            form.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function deleteCategory(index) {
            if (!confirm('Are you sure you want to delete this category? Products in this category will be affected.')) return;
            const category = categories[index];
            products = products.map(p => {
                if (p.category === category) p.enabled = false;
                return p;
            });
            categories.splice(index, 1);
            saveData();
            loadCategories();
            loadProducts();
            showNotification('Category deleted successfully', 'success');
        }

        // Coupons
        function loadCoupons() {
            try {
                const couponList = document.getElementById('couponList');
                couponList.innerHTML = coupons.length ? coupons.map((coupon, index) => `
                    <tr>
                        <td>${coupon.code}</td>
                        <td>${(coupon.discount * 100).toFixed(0)}%</td>
                        <td>
                            <button class="btn btn-primary" onclick="editCoupon(${index})" aria-label="Edit ${coupon.code}">Edit</button>
                            <button class="btn btn-secondary" onclick="deleteCoupon(${index})" aria-label="Delete ${coupon.code}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('') : '<tr><td colspan="3">No coupons found</td></tr>';
            } catch (e) {
                console.error('Error loading coupons:', e);
                showNotification('Error loading coupons', 'error');
            }
        }

        function showAddCouponForm() {
            const form = document.getElementById('addCouponForm');
            form.style.display = form.style.display === 'block' ? 'none' : 'block';
            if (form.style.display === 'block') {
                document.getElementById('editCouponId').value = '';
                document.getElementById('addCouponForm').reset();
                document.querySelectorAll('.form-group .error').forEach(error => error.textContent = '');
                form.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function cancelAddCoupon() {
            document.getElementById('addCouponForm').style.display = 'none';
            document.getElementById('addCouponForm').reset();
            document.querySelectorAll('.form-group .error').forEach(error => error.textContent = '');
        }

        document.getElementById('addCouponForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const editId = document.getElementById('editCouponId').value;
            const code = document.getElementById('couponCode').value.trim().toUpperCase();
            const discount = parseFloat(document.getElementById('couponDiscount').value) / 100;

            const codeError = document.getElementById('couponCodeError');
            const discountError = document.getElementById('couponDiscountError');
            document.querySelectorAll('.form-group .error').forEach(error => error.textContent = '');

            let hasError = false;
            if (code.length < 3) {
                codeError.textContent = 'Coupon code must be at least 3 characters';
                hasError = true;
            }
            if (coupons.some(c => c.code === code) && editId === '') {
                codeError.textContent = 'Coupon code already exists';
                hasError = true;
            }
            if (isNaN(discount) || discount <= 0 || discount >= 1) {
                discountError.textContent = 'Discount must be between 1 and 99';
                hasError = true;
            }

            if (hasError) {
                showNotification('Please fix the errors in the form', 'error');
                return;
            }

            if (editId !== '') {
                const index = parseInt(editId);
                coupons[index] = { code, discount };
                showNotification('Coupon updated successfully', 'success');
            } else {
                coupons.push({ code, discount });
                showNotification('Coupon added successfully', 'success');
            }
            saveData();
            loadCoupons();
            cancelAddCoupon();
        });

        function editCoupon(index) {
            const coupon = coupons[index];
            document.getElementById('editCouponId').value = index;
            document.getElementById('couponCode').value = coupon.code;
            document.getElementById('couponDiscount').value = (coupon.discount * 100).toFixed(0);
            const form = document.getElementById('addCouponForm');
            form.style.display = 'block';
            form.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function deleteCoupon(index) {
            if (!confirm('Are you sure you want to delete this coupon?')) return;
            coupons.splice(index, 1);
            saveData();
            loadCoupons();
            showNotification('Coupon deleted successfully', 'success');
        }

        // Logout
        function logout() {
            currentAdmin = null;
            localStorage.removeItem('currentAdmin');
            saveData();
            window.location.href = 'admin-login.html';
        }

        // Initialize
        if (!currentAdmin) {
            window.location.href = 'admin-login.html';
        } else {
            toggleSection('productsSection');
            updateOrderButtonDot();
        }

        let searchTimeout;
        document.getElementById('searchProducts').addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(loadProducts, 300);
        });
        document.getElementById('sortProducts').addEventListener('change', loadProducts);

        window.placeOrder = placeOrder;
    </script>
</body>
</html>