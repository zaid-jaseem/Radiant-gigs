<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard - Radiant Gigs</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- HTML -->
    <header>
        <div class="logo">
            <i class="fas fa-pencil-alt"></i>
            <h1>Radiant Gigs</h1>
        </div>
        <nav>
            <button class="btn btn-secondary" onclick="toggleSection('homeSection')" aria-label="View Home">Home</button>
            <button class="btn btn-secondary" onclick="toggleSection('cartSection')" aria-label="View Cart">Cart</button>
            <button class="btn btn-secondary" onclick="toggleSection('wishlistSection')" aria-label="View Wishlist">Wishlist</button>
            <button class="btn btn-secondary" onclick="toggleSection('ordersSection')" aria-label="View Orders">Orders</button>
            <button class="btn btn-secondary" onclick="toggleSection('profileSection')" aria-label="View Profile">Profile</button>
            <button class="btn btn-primary" onclick="logout()" aria-label="Logout">Logout</button>
        </nav>
    </header>
    <main>
        <section id="homeSection">
            <h2>Products</h2>
            <div class="sort-controls">
                <select id="sortProducts" aria-label="Sort products">
                    <option value="name-asc">Name (A-Z)</option>
                    <option value="name-desc">Name (Z-A)</option>
                    <option value="price-asc">Price (Low to High)</option>
                    <option value="price-desc">Price (High to Low)</option>
                </select>
                <select id="categoryFilter" aria-label="Filter by category" onchange="resetFilters(this.value)">
                    <option value="">All Categories</option>
                </select>
                <input type="text" id="searchProducts" placeholder="Search products..." aria-label="Search products">
            </div>
            <div class="product-grid" id="productList"></div>
        </section>
        <section id="cartSection" class="hidden">
            <h2>Your Cart</h2>
            <div class="coupon-section">
                <div class="form-group">
                    <label for="couponCode">Apply Coupon</label>
                    <div class="coupon-input">
                        <input type="text" id="couponCode" placeholder="Enter coupon code" aria-label="Coupon code">
                        <button class="btn btn-primary" onclick="applyCoupon()" aria-label="Apply coupon">Apply</button>
                    </div>
                    <span id="couponError" class="error"></span>
                    <div id="appliedCoupon" class="applied-coupon" style="display: none;">
                        <p>Applied: <span id="couponCodeDisplay"></span> (<span id="couponDiscount"></span>% off) <button class="btn btn-secondary btn-small" onclick="removeCoupon()" aria-label="Remove coupon">Remove</button></p>
                    </div>
                </div>
            </div>
            <div class="product-grid" id="cartList"></div>
            <div id="cartTotal" class="cart-total"></div>
            <button id="checkoutButton" class="btn btn-primary" onclick="showDeliveryForm()" aria-label="Proceed to Checkout" style="display: none; margin-top: 20px;">Checkout</button>
        </section>
        <section id="wishlistSection" class="hidden">
            <h2>Your Wishlist</h2>
            <div class="product-grid" id="wishlistList"></div>
        </section>
        <section id="ordersSection" class="hidden">
            <h2>Your Orders</h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Date</th>
                        <th>Total</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="orderList"></tbody>
            </table>
        </section>
        <section id="profileSection" class="hidden">
            <h2>Your Profile</h2>
            <form id="profileForm" class="form" aria-label="Edit Profile Form">
                <div class="form-group">
                    <label for="profileUsername">Username</label>
                    <input type="text" id="profileUsername" required aria-describedby="profileUsernameError">
                    <span id="profileUsernameError" class="error"></span>
                </div>
                <div class="form-group">
                    <label for="profileEmail">Email</label>
                    <input type="email" id="profileEmail" readonly aria-describedby="profileEmailError">
                    <span id="profileEmailError" class="error"></span>
                </div>
                <div class="form-group">
                    <label for="profilePhone">Phone</label>
                    <input type="tel" id="profilePhone" required aria-describedby="profilePhoneError">
                    <span id="profilePhoneError" class="error"></span>
                </div>
                <div class="form-group">
                    <label for="profileAddress">Address</label>
                    <textarea id="profileAddress" required aria-describedby="profileAddressError"></textarea>
                    <span id="profileAddressError" class="error"></span>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary" aria-label="Save Profile">Save</button>
                    <button type="button" class="btn btn-secondary" onclick="loadProfile()" aria-label="Reset">Reset</button>
                </div>
            </form>
        </section>
    </main>
    <footer>
        <p>© 2025 Radiant Gigs. All rights reserved.</p>
    </footer>
    <div id="notification" class="notification"></div>
    <div id="productDetailsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <button class="close-modal" onclick="closeProductDetails()" aria-label="Close Modal">
                <i class="fas fa-times"></i>
            </button>
            <div id="productDetailsContent"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeProductDetails()" aria-label="Back">Back</button>
            </div>
        </div>
    </div>
    <div id="orderDetailsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <button class="close-modal" onclick="closeOrderDetails()" aria-label="Close Modal">
                <i class="fas fa-times"></i>
            </button>
            <div id="orderDetailsContent"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeOrderDetails()" aria-label="Back to Orders">Back to Orders</button>
            </div>
        </div>
    </div>
    <div id="deliveryDetailsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <button class="close-modal" onclick="closeDeliveryForm()" aria-label="Close Modal">
                <i class="fas fa-times"></i>
            </button>
            <h3>Delivery Details</h3>
            <form id="deliveryForm" class="form" aria-label="Delivery Details Form">
                <div class="form-group">
                    <label for="deliveryName">Name</label>
                    <input type="text" id="deliveryName" required aria-describedby="deliveryNameError">
                    <span id="deliveryNameError" class="error"></span>
                </div>
                <div class="form-group">
                    <label for="deliveryPhone">Phone</label>
                    <input type="tel" id="deliveryPhone" required aria-describedby="deliveryPhoneError">
                    <span id="deliveryPhoneError" class="error"></span>
                </div>
                <div class="form-group">
                    <label for="deliveryAddress">Delivery Address</label>
                    <textarea id="deliveryAddress" required aria-describedby="deliveryAddressError"></textarea>
                    <span id="deliveryAddressError" class="error"></span>
                </div>
                <div class="form-group">
                    <label for="deliveryNotes">Notes (Optional)</label>
                    <textarea id="deliveryNotes" aria-describedby="deliveryNotesError"></textarea>
                    <span id="deliveryNotesError" class="error"></span>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary" aria-label="Confirm Delivery">Confirm</button>
                    <button type="button" class="btn btn-secondary" onclick="closeDeliveryForm()" aria-label="Cancel">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- CSS -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        body {
            background: #1a1a2d;
            color: #fff;
        }
        .btn {
            padding: 10px 20px;
            border-radius: 25px;
            border: none;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(57, 255, 20, 0.5);
        }
        .btn-primary {
            background: #39ff14;
            color: #1a1a2d;
        }
        .btn-secondary {
            background: #00ddeb;
            color: #fff;
        }
        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        @keyframes neonGlow {
            0% { box-shadow: 0 0 5px rgba(57, 255, 20, 0.5); }
            50% { box-shadow: 0 0 15px rgba(57, 255, 20, 0.8), 0 0 20px rgba(0, 221, 235, 0.5); }
            100% { box-shadow: 0 0 5px rgba(57, 255, 20, 0.5); }
        }
        @keyframes scaleIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        header {
            background: linear-gradient(135deg, #6b48ff, #00ddeb);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logo i {
            background: #39ff14;
            color: #1a1a2d;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .logo h1 {
            font-size: 28px;
            margin: 0;
        }
        header nav {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        main {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        section {
            background: #2a2a3d;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.5s ease-in;
            position: relative;
        }
        section.hidden {
            display: none;
        }
        h2 {
            font-size: 28px;
            margin-bottom: 20px;
        }
        .sort-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .sort-controls select, .sort-controls input {
            flex: 1;
            min-width: 150px;
            padding: 12px;
            border: 2px solid transparent;
            border-radius: 10px;
            font-size: 14px;
            color: #1a1a2d;
            background: #fff;
            background-clip: padding-box;
            transition: border 0.3s, box-shadow 0.3s;
        }
        .sort-controls select:focus, .sort-controls input:focus {
            outline: none;
            border: 2px solid #39ff14;
            box-shadow: 0 0 8px rgba(57, 255, 20, 0.5);
        }
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
        }
        .product-card, .cart-card, .wishlist-card {
            background: #1a1a2d;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: transform 0.3s, border 0.3s;
            border: 2px solid transparent;
        }
        .product-card:hover, .cart-card:hover, .wishlist-card:hover {
            transform: scale(1.05);
            border: 2px solid #39ff14;
        }
        .product-card img, .cart-card img, .wishlist-card img {
            width: 100%;
            height: 200px;
            object-fit: contain;
            border-radius: 5px;
            margin-bottom: 10px;
            background: #fff;
        }
        .product-card h3, .cart-card h3, .wishlist-card h3 {
            font-size: 16px;
            color: #00ddeb;
            margin-bottom: 8px;
        }
        .product-card p, .cart-card p, .wishlist-card p {
            font-size: 12px;
            color: #e0e0e0;
            margin-bottom: 8px;
        }
        .product-card .btn-container, .cart-card .btn-container, .wishlist-card .btn-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .product-card .btn, .cart-card .btn, .wishlist-card .btn {
            margin: 0;
            padding: 8px 15px;
            font-size: 12px;
        }
        .cart-card input[type="number"] {
            width: 60px;
            padding: 5px;
            border-radius: 5px;
            border: none;
            background: #2a2a3d;
            color: #fff;
            text-align: center;
            margin: 10px auto;
        }
        .cart-total {
            margin-top: 20px;
            text-align: right;
            font-size: 18px;
            color: #39ff14;
        }
        .coupon-section {
            margin-bottom: 20px;
            background: rgba(42, 42, 61, 0.7);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        .coupon-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .coupon-input input {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            color: #fff;
            background: #2a2a3d;
        }
        .form-group .error {
            color: #39ff14;
            font-size: 12px;
            display: block;
            margin-top: 5px;
        }
        .applied-coupon {
            margin-top: 10px;
            color: #00ddeb;
        }
        .applied-coupon p {
            font-size: 14px;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .data-table th, .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #3a3a4d;
        }
        .data-table th {
            background: #1a1a2d;
            color: #00ddeb;
        }
        .data-table td {
            color: #e0e0e0;
        }
        .data-table tr:hover {
            background: #3a3a4d;
        }
        .form {
            background: #1a1a2d;
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            color: #e0e0e0;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            color: #fff;
            background: #2a2a3d;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .form-group .error {
            color: #39ff14;
            font-size: 12px;
            display: block;
            margin-top: 5px;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 10px;
            color: #1a1a2d;
            display: none;
            z-index: 1000;
        }
        .notification.success {
            background: #00ddeb;
            box-shadow: 0 0 15px rgba(0, 221, 235, 0.5);
            animation: slideIn 0.3s ease-in;
        }
        .notification.error {
            background: #39ff14;
            box-shadow: 0 0 15px rgba(57, 255, 20, 0.5);
            animation: slideIn 0.3s ease-in;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease-in;
        }
        .modal-content {
            background: #2a2a3d;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            position: relative;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 0 20px rgba(57, 255, 20, 0.3);
            animation: scaleIn 0.3s ease-out;
        }
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #e0e0e0;
            font-size: 24px;
            cursor: pointer;
            transition: color 0.3s, transform 0.3s;
        }
        .close-modal:hover {
            color: #39ff14;
            transform: scale(1.2);
        }
        .modal-footer {
            margin-top: 20px;
            text-align: right;
        }
        .btn-container {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        /* Product Details Modal */
        .product-details-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .product-carousel {
            flex: 1;
            min-width: 300px;
            position: relative;
            border-radius: 10px;
            overflow: hidden;
        }
        .carousel-images {
            display: flex;
            transition: transform 0.3s ease;
        }
        .carousel-images img {
            width: 100%;
            height: 300px;
            object-fit: contain;
            background: #fff;
            border-radius: 10px;
        }
        .carousel-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            color: #39ff14;
            border: none;
            padding: 10px;
            cursor: pointer;
            font-size: 20px;
            transition: background 0.3s;
        }
        .carousel-arrow:hover {
            background: rgba(0, 0, 0, 0.8);
        }
        .carousel-arrow.left {
            left: 10px;
        }
        .carousel-arrow.right {
            right: 10px;
        }
        .carousel-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
        }
        .carousel-dot {
            width: 10px;
            height: 10px;
            background: #e0e0e0;
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.3s;
        }
        .carousel-dot.active {
            background: #39ff14;
        }
        .product-details {
            flex: 1;
            min-width: 300px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(57, 255, 20, 0.3);
        }
        .product-details h3 {
            font-size: 24px;
            color: #00ddeb;
            margin-bottom: 15px;
            animation: neonGlow 2s infinite;
        }
        .product-details p {
            margin-bottom: 10px;
            color: #e0e0e0;
            font-size: 14px;
            border-left: 3px solid #39ff14;
            padding-left: 10px;
        }
        .product-details p strong {
            color: #fff;
        }
        /* Order Details Modal */
        .order-details-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .order-details-container h3 {
            font-size: 24px;
            color: #00ddeb;
            margin-bottom: 15px;
            animation: neonGlow 2s infinite;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }
        .delivery-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(57, 255, 20, 0.3);
            animation: scaleIn 0.3s ease-out;
        }
        .delivery-card h4 {
            font-size: 18px;
            color: #00ddeb;
            margin-bottom: 15px;
        }
        .delivery-card p {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            color: #e0e0e0;
            font-size: 14px;
        }
        .delivery-card p i {
            color: #39ff14;
        }
        .modal-content table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 10px;
            border-radius: 10px;
            overflow: hidden;
            animation: scaleIn 0.3s ease-out;
        }
        .modal-content table th, .modal-content table td {
            padding: 12px;
            border-bottom: 1px solid #3a3a4d;
            text-align: left;
        }
        .modal-content table th {
            background: #1a1a2d;
            color: #00ddeb;
            font-weight: 600;
        }
        .modal-content table td {
            background: rgba(255, 255, 255, 0.05);
            color: #e0e0e0;
        }
        .modal-content table tr:nth-child(even) td {
            background: rgba(255, 255, 255, 0.1);
        }
        .modal-content table tr:hover td {
            background: rgba(57, 255, 20, 0.2);
            transition: background 0.3s;
        }
        .modal-content table th:first-child, .modal-content table td:first-child {
            border-top-left-radius: 10px;
            border-bottom-left-radius: 10px;
        }
        .modal-content table th:last-child, .modal-content table td:last-child {
            border-top-right-radius: 10px;
            border-bottom-right-radius: 10px;
        }
        footer {
            background: #1a1a2d;
            padding: 15px;
            text-align: center;
            border-top: 1px solid #2a2a3d;
        }
        footer p {
            font-size: 14px;
            color: #e0e0e0;
        }
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 15px;
            }
            header nav {
                flex-wrap: wrap;
                justify-content: center;
            }
            .sort-controls {
                flex-direction: column;
            }
            .product-grid {
                grid-template-columns: 1fr;
            }
            .cart-total {
                text-align: center;
            }
            .data-table {
                font-size: 12px;
            }
            .data-table th, .data-table td {
                padding: 8px;
            }
            .product-details-container {
                flex-direction: column;
            }
            .product-carousel, .product-details {
                min-width: 100%;
            }
            .carousel-images img {
                height: 200px;
            }
            .modal-content {
                padding: 20px;
                width: 95%;
            }
            .modal-content table {
                font-size: 12px;
            }
            .modal-content table th, .modal-content table td {
                padding: 8px;
            }
            .coupon-input {
                flex-direction: column;
            }
            .coupon-input input,
            .coupon-input button {
                width: 100%;
            }
        }
        @media (max-width: 480px) {
            .carousel-arrow {
                padding: 8px;
                font-size: 16px;
            }
            .carousel-dots {
                gap: 5px;
            }
            .carousel-dot {
                width: 8px;
                height: 8px;
            }
        }
    </style>

    <!-- JavaScript -->
    <script>
        // Data Initialization
        let products, users, orders, categories, cart, wishlist, coupons, currentUser;
        function resetData() {
            try {
                const userData = localStorage.getItem('currentUser');
                currentUser = userData ? JSON.parse(userData) : null;

                products = JSON.parse(localStorage.getItem('products')) || [];
                users = JSON.parse(localStorage.getItem('users')) || [];
                orders = JSON.parse(localStorage.getItem('orders')) || [];
                categories = JSON.parse(localStorage.getItem('categories')) || ['Notebooks', 'Pens', 'Sketchbooks'];
                cart = JSON.parse(localStorage.getItem('cart')) || [];
                wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
                coupons = JSON.parse(localStorage.getItem('coupons')) || [
                    { code: 'SAVE10', discount: 0.1 },
                    { code: 'SAVE20', discount: 0.2 }
                ];

                products = products.map(p => ({
                    ...p,
                    featured: p.featured !== undefined ? p.featured : false,
                    images: Array.isArray(p.images) ? p.images : [],
                    enabled: p.enabled !== undefined ? p.enabled : true,
                    lastModified: p.lastModified || new Date().toISOString()
                }));

                users = users.map(u => ({
                    ...u,
                    status: u.status || 'active',
                    registeredAt: u.registeredAt || new Date().toISOString(),
                    phone: u.phone || 'Not provided',
                    address: u.address || 'Not provided'
                }));

                saveData();
            } catch (e) {
                console.error('Failed to initialize data:', e);
                showNotification('Failed to initialize data. Please clear localStorage.', 'error');
                currentUser = null;
            }
        }
        resetData();

        // Save Data
        function saveData() {
            try {
                localStorage.setItem('products', JSON.stringify(products));
                localStorage.setItem('users', JSON.stringify(users));
                localStorage.setItem('orders', JSON.stringify(orders));
                localStorage.setItem('categories', JSON.stringify(categories));
                localStorage.setItem('cart', JSON.stringify(cart));
                localStorage.setItem('wishlist', JSON.stringify(wishlist));
                localStorage.setItem('coupons', JSON.stringify(coupons));
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            } catch (e) {
                showNotification('Failed to save data: Storage limit reached', 'error');
                console.error('Failed to save data:', e);
            }
        }

        // Notification
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            notification.className = `notification ${type}`;
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        // Section Toggle
        function toggleSection(sectionId) {
            document.querySelectorAll('section').forEach(section => section.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
            if (sectionId === 'homeSection') loadProducts();
            else if (sectionId === 'cartSection') loadCart();
            else if (sectionId === 'wishlistSection') loadWishlist();
            else if (sectionId === 'ordersSection') loadOrders();
            else if (sectionId === 'profileSection') loadProfile();
        }

        // Reset Filters
        function resetFilters(category) {
            if (category === '') {
                document.getElementById('searchProducts').value = '';
                document.getElementById('sortProducts').value = 'name-asc';
            }
            loadProducts();
        }

        // Home Section (Products)
        function loadProducts() {
            try {
                const sort = document.getElementById('sortProducts').value;
                const category = document.getElementById('categoryFilter').value;
                const search = document.getElementById('searchProducts').value.toLowerCase();
                const productList = document.getElementById('productList');
                const categoryFilter = document.getElementById('categoryFilter');

                if (!Array.isArray(products)) {
                    console.error('Products is not an array:', products);
                    productList.innerHTML = '<p>Error: Invalid product data</p>';
                    return;
                }

                let filteredProducts = products.filter(p => {
                    try {
                        return (p.name || '').toLowerCase().includes(search) &&
                               (category === '' || (p.category || '') === category) &&
                               p.enabled;
                    } catch (e) {
                        console.error('Error filtering product:', p, e);
                        return false;
                    }
                });

                filteredProducts.sort((a, b) => {
                    if (sort === 'name-asc') return (a.name || '').localeCompare(b.name || '');
                    if (sort === 'name-desc') return (b.name || '').localeCompare(a.name || '');
                    if (sort === 'price-asc') return (a.discountedPrice || a.mrpPrice || 0) - (b.discountedPrice || b.mrpPrice || 0);
                    if (sort === 'price-desc') return (b.discountedPrice || b.mrpPrice || 0) - (a.discountedPrice || a.mrpPrice || 0);
                    return 0;
                });

                productList.innerHTML = filteredProducts.length ? filteredProducts.map(p => {
                    try {
                        const inCart = cart.some(item => item.user === currentUser.email && item.productId === p.id);
                        const inWishlist = wishlist.some(item => item.user === currentUser.email && item.productId === p.id);
                        return `
                            <div class="product-card">
                                <img src="${(p.images && p.images[0]) || 'https://via.placeholder.com/300'}" alt="${p.name || 'Product'}">
                                <h3>${p.name || 'Unknown'}</h3>
                                <p>₹${((p.discountedPrice || p.mrpPrice || 0)).toFixed(2)}</p>
                                ${p.stock === 0 ? `<p style="color: #ff4444;">Out of Stock</p>` : `<p>Stock: ${p.stock}</p>`}
                                <div class="btn-container">
                                    <button class="btn btn-primary" onclick="viewProductDetails(${p.id})" aria-label="View ${p.name || 'product'}">View</button>
                                    <button class="btn btn-secondary" onclick="addToCart(${p.id})" aria-label="Add ${p.name || 'product'} to cart" ${inCart || p.stock === 0 ? 'disabled' : ''}>
                                        ${inCart ? 'In Cart' : 'Add to Cart'}
                                    </button>
                                    <button class="btn btn-secondary" onclick="addToWishlist(${p.id})" aria-label="${inWishlist ? 'Remove from' : 'Add to'} wishlist ${p.name || 'product'}">
                                        <i class="fas fa-heart" style="color: ${inWishlist ? '#39ff14' : '#fff'}"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    } catch (e) {
                        console.error('Error rendering product:', p, e);
                        return '';
                    }
                }).join('') : '<p>No products found</p>';

                categoryFilter.innerHTML = '<option value="">All Categories</option>' + categories.map(cat => `<option value="${cat}" ${cat === category ? 'selected' : ''}>${cat}</option>`).join('');
            } catch (e) {
                console.error('Error loading products:', e);
                showNotification('Error loading products. Check console for details.', 'error');
                document.getElementById('productList').innerHTML = '<p>Error loading products</p>';
            }
        }

        // Cart Section
        function loadCart() {
            try {
                const cartList = document.getElementById('cartList');
                const cartTotal = document.getElementById('cartTotal');
                const checkoutButton = document.getElementById('checkoutButton');

                if (!Array.isArray(cart)) {
                    console.error('Cart is not an array:', cart);
                    cartList.innerHTML = '<p>Error: Invalid cart data</p>';
                    return;
                }

                const userCart = cart.filter(item => item.user === currentUser.email && item.productId);
                const cartItems = userCart.map(item => {
                    const product = products.find(p => p.id === item.productId);
                    return { ...item, product };
                }).filter(item => item.product);

                let subtotal = 0;
                cartList.innerHTML = cartItems.length ? cartItems.map(item => {
                    const price = item.product.discountedPrice || item.product.mrpPrice || 0;
                    const itemTotal = price * item.quantity;
                    subtotal += itemTotal;
                    return `
                        <div class="cart-card">
                            <img src="${(item.product.images && item.product.images[0]) || 'https://via.placeholder.com/300'}" alt="${item.product.name || 'Product'}">
                            <h3>${item.product.name || 'Unknown'}</h3>
                            <p>Price: ₹${price.toFixed(2)}</p>
                            <input type="number" min="1" max="${item.product.stock}" value="${item.quantity}" onchange="updateCartQuantity(${item.product.id}, this.value)" aria-label="Quantity for ${item.product.name || 'product'}">
                            <p>Total: ₹${itemTotal.toFixed(2)}</p>
                            <div class="btn-container">
                                <button class="btn btn-primary" onclick="viewProductDetails(${item.product.id})" aria-label="View ${item.product.name || 'product'}">View</button>
                                <button class="btn btn-secondary" onclick="removeFromCart(${item.product.id})" aria-label="Remove ${item.product.name || 'product'} from cart"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                }).join('') : '<p>Your cart is empty</p>';

                // Calculate discount
                const appliedCoupon = cart.find(item => item.user === currentUser.email && item.coupon);
                let discount = 0;
                if (appliedCoupon) {
                    const coupon = coupons.find(c => c.code === appliedCoupon.coupon);
                    if (coupon) {
                        discount = subtotal * coupon.discount;
                        document.getElementById('appliedCoupon').style.display = 'block';
                        document.getElementById('couponCodeDisplay').textContent = coupon.code;
                        document.getElementById('couponDiscount').textContent = (coupon.discount * 100).toFixed(0);
                    } else {
                        removeCoupon();
                    }
                } else {
                    document.getElementById('appliedCoupon').style.display = 'none';
                }

                const total = subtotal - discount;

                cartTotal.innerHTML = cartItems.length ? `
                    <p>Subtotal: ₹${subtotal.toFixed(2)}</p>
                    <p>Discount: ₹${discount.toFixed(2)}</p>
                    <p><strong>Total: ₹${total.toFixed(2)}</strong></p>
                ` : '';
                checkoutButton.style.display = cartItems.length && total > 0 ? 'block' : 'none';
            } catch (e) {
                console.error('Error loading cart:', e);
                showNotification('Error loading cart', 'error');
                document.getElementById('cartList').innerHTML = '<p>Error loading cart</p>';
            }
        }

        function applyCoupon() {
            const code = document.getElementById('couponCode').value.trim().toUpperCase();
            const error = document.getElementById('couponError');
            error.textContent = '';

            if (!code) {
                error.textContent = 'Please enter a coupon code';
                return;
            }

            const coupon = coupons.find(c => c.code === code);
            if (!coupon) {
                error.textContent = 'Invalid coupon code';
                showNotification('Invalid coupon code', 'error');
                return;
            }

            const userCart = cart.find(item => item.user === currentUser.email && item.coupon);
            if (userCart) {
                userCart.coupon = code;
            } else {
                cart.push({ user: currentUser.email, coupon: code });
            }

            saveData();
            document.getElementById('couponCode').value = '';
            loadCart();
            showNotification('Coupon applied successfully', 'success');
        }

        function removeCoupon() {
            cart = cart.filter(item => !(item.user === currentUser.email && item.coupon));
            saveData();
            loadCart();
            showNotification('Coupon removed', 'success');
        }

        function addToCart(productId, quantity = 1) {
            const product = products.find(p => p.id === productId);
            if (!product) {
                showNotification('Product not found', 'error');
                return;
            }
            if (product.stock < quantity) {
                showNotification('Insufficient stock', 'error');
                return;
            }
            const existingItem = cart.find(item => item.user === currentUser.email && item.productId === productId);
            if (existingItem) {
                existingItem.quantity = Math.min(existingItem.quantity + quantity, product.stock);
            } else {
                cart.push({ user: currentUser.email, productId, quantity });
            }
            saveData();
            loadProducts();
            loadCart();
            showNotification(`${product.name} added to cart`, 'success');
        }

        function updateCartQuantity(productId, quantity) {
            quantity = parseInt(quantity);
            const product = products.find(p => p.id === productId);
            if (!product) {
                showNotification('Product not found', 'error');
                return;
            }
            if (quantity <= 0 || isNaN(quantity)) {
                removeFromCart(productId);
                return;
            }
            if (quantity > product.stock) {
                showNotification('Quantity exceeds available stock', 'error');
                loadCart();
                return;
            }
            const item = cart.find(item => item.user === currentUser.email && item.productId === productId);
            if (item) {
                item.quantity = quantity;
                saveData();
                loadCart();
                showNotification('Cart updated', 'success');
            }
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => !(item.user === currentUser.email && item.productId === productId));
            saveData();
            loadProducts();
            loadCart();
            showNotification('Item removed from cart', 'success');
        }

        // Delivery Details Form
        function showDeliveryForm() {
            const user = users.find(u => u.email === currentUser.email);
            if (!user) {
                showNotification('User not found', 'error');
                logout();
                return;
            }
            document.getElementById('deliveryName').value = user.username || '';
            document.getElementById('deliveryPhone').value = user.phone || '';
            document.getElementById('deliveryAddress').value = user.address || '';
            document.getElementById('deliveryNotes').value = '';
            document.querySelectorAll('#deliveryForm .error').forEach(error => error.textContent = '');
            document.getElementById('deliveryDetailsModal').style.display = 'flex';
            document.getElementById('deliveryName').focus();
        }

        function closeDeliveryForm() {
            document.getElementById('deliveryDetailsModal').style.display = 'none';
            document.getElementById('deliveryForm').reset();
            document.querySelectorAll('#deliveryForm .error').forEach(error => error.textContent = '');
        }

        document.getElementById('deliveryForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('deliveryName').value.trim();
            const phone = document.getElementById('deliveryPhone').value.trim();
            const address = document.getElementById('deliveryAddress').value.trim();
            const notes = document.getElementById('deliveryNotes').value.trim();

            const nameError = document.getElementById('deliveryNameError');
            const phoneError = document.getElementById('deliveryPhoneError');
            const addressError = document.getElementById('deliveryAddressError');
            document.querySelectorAll('#deliveryForm .error').forEach(error => error.textContent = '');

            let hasError = false;
            if (name.length < 2) {
                nameError.textContent = 'Name must be at least 2 characters';
                hasError = true;
            }
            if (!/^\+?\d{10,15}$/.test(phone)) {
                phoneError.textContent = 'Invalid phone number';
                hasError = true;
            }
            if (address.length < 5) {
                addressError.textContent = 'Address must be at least 5 characters';
                hasError = true;
            }

            if (hasError) {
                showNotification('Please fix the errors in the form', 'error');
                return;
            }

            const deliveryDetails = { name, phone, address, notes };
            placeOrder(deliveryDetails);
            closeDeliveryForm();
        });

        // Wishlist Section
        function loadWishlist() {
            try {
                const wishlistList = document.getElementById('wishlistList');
                if (!Array.isArray(wishlist)) {
                    console.error('Wishlist is not an array:', wishlist);
                    wishlistList.innerHTML = '<p>Error: Invalid wishlist data</p>';
                    return;
                }

                const userWishlist = wishlist.filter(item => item.user === currentUser.email);
                const wishlistItems = userWishlist.map(item => {
                    const product = products.find(p => p.id === item.productId);
                    return { ...item, product };
                }).filter(item => item.product);

                wishlistList.innerHTML = wishlistItems.length ? wishlistItems.map(item => {
                    const price = item.product.discountedPrice || item.product.mrpPrice || 0;
                    return `
                        <div class="wishlist-card">
                            <img src="${(item.product.images && item.product.images[0]) || 'https://via.placeholder.com/300'}" alt="${item.product.name || 'Product'}">
                            <h3>${item.product.name || 'Unknown'}</h3>
                            <p>Price: ₹${price.toFixed(2)}</p>
                            <div class="btn-container">
                                <button class="btn btn-primary" onclick="viewProductDetails(${item.product.id})" aria-label="View ${item.product.name || 'product'}">View</button>
                                <button class="btn btn-secondary" onclick="addToCart(${item.product.id})" aria-label="Add ${item.product.name || 'product'} to cart" ${item.product.stock === 0 ? 'disabled' : ''}>Add to Cart</button>
                                <button class="btn btn-secondary" onclick="removeFromWishlist(${item.product.id})" aria-label="Remove ${item.product.name || 'product'} from wishlist"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                }).join('') : '<p>Your wishlist is empty</p>';
            } catch (e) {
                console.error('Error loading wishlist:', e);
                showNotification('Error loading wishlist', 'error');
                document.getElementById('wishlistList').innerHTML = '<p>Error loading wishlist</p>';
            }
        }

        function addToWishlist(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) {
                showNotification('Product not found', 'error');
                return;
            }
            const exists = wishlist.some(item => item.user === currentUser.email && item.productId === productId);
            if (exists) {
                wishlist = wishlist.filter(item => !(item.user === currentUser.email && item.productId === productId));
                showNotification(`${product.name} removed from wishlist`, 'success');
            } else {
                wishlist.push({ user: currentUser.email, productId });
                showNotification(`${product.name} added to wishlist`, 'success');
            }
            saveData();
            loadProducts();
            loadWishlist();
        }

        function removeFromWishlist(productId) {
            wishlist = wishlist.filter(item => !(item.user === currentUser.email && item.productId === productId));
            saveData();
            loadProducts();
            loadWishlist();
            showNotification('Item removed from wishlist', 'success');
        }

        // Orders Section
        function loadOrders() {
            try {
                const orderList = document.getElementById('orderList');
                const userOrders = orders.filter(o => o.user === currentUser.email);
                userOrders.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
                orderList.innerHTML = userOrders.length ? userOrders.map(o => `
                    <tr>
                        <td>${o.id}</td>
                        <td>${new Date(o.date || Date.now()).toLocaleDateString('en-IN')}</td>
                        <td>₹${(o.total || 0).toFixed(2)}</td>
                        <td style="color:${o.status === 'Processing' ? '#39ff14' : o.status === 'Shipped' ? '#00ddeb' : o.status === 'Delivered' ? '#00ffaa' : '#ff4444'}">${o.status || 'Unknown'}</td>
                        <td>
                            <button class="btn btn-primary" onclick="viewOrderDetails(${o.id})" aria-label="View order ${o.id}">View</button>
                        </td>
                    </tr>
                `).join('') : '<tr><td colspan="5">No orders found</td></tr>';
            } catch (e) {
                console.error('Error loading orders:', e);
                showNotification('Error loading orders', 'error');
                document.getElementById('orderList').innerHTML = '<tr><td colspan="5">Error loading orders</td></tr>';
            }
        }

        // Order Details Modal
        function viewOrderDetails(orderId) {
            const order = orders.find(o => o.id === orderId && o.user === currentUser.email);
            if (!order) {
                showNotification('Order not found', 'error');
                return;
            }
            const content = document.getElementById('orderDetailsContent');
            const items = order.items || [];
            const itemDetails = items.map(item => {
                const product = products.find(p => p.id === item.id);
                const price = (product && (product.discountedPrice || product.mrpPrice)) || item.price || 0;
                const amount = price * (item.quantity || 0);
                return {
                    name: product ? product.name : `Unknown (ID: ${item.id})`,
                    quantity: item.quantity || 0,
                    price: price.toFixed(2),
                    amount: amount.toFixed(2)
                };
            });
            const statusColor = order.status === 'Processing' ? '#39ff14' : order.status === 'Shipped' ? '#00ddeb' : order.status === 'Delivered' ? '#00ffaa' : '#ff4444';
            content.innerHTML = `
                <div class="order-details-container">
                    <h3>Order #${order.id} <span class="status-badge" style="background: ${statusColor}">${order.status || 'Unknown'}</span></h3>
                    <p><strong>Date:</strong> ${new Date(order.date || Date.now()).toLocaleDateString('en-IN')}</p>
                    ${order.coupon ? `<p><strong>Coupon:</strong> ${order.coupon} (${order.discountPercentage ? (order.discountPercentage * 100).toFixed(0) + '% off' : 'Unknown'})</p>` : ''}
                    ${order.discountAmount ? `<p><strong>Discount:</strong> ₹${order.discountAmount.toFixed(2)}</p>` : ''}
                    <p><strong>Total:</strong> ₹${(order.total || 0).toFixed(2)}</p>
                    <div class="delivery-card">
                        <h4>Delivery Details</h4>
                        <p><i class="fas fa-user"></i> <strong>Name:</strong> ${order.deliveryDetails?.name || 'Not provided'}</p>
                        <p><i class="fas fa-phone"></i> <strong>Phone:</strong> ${order.deliveryDetails?.phone || 'Not provided'}</p>
                        <p><i class="fas fa-map-marker-alt"></i> <strong>Address:</strong> ${order.deliveryDetails?.address || 'Not provided'}</p>
                        ${order.deliveryDetails?.notes ? `<p><i class="fas fa-sticky-note"></i> <strong>Notes:</strong> ${order.deliveryDetails.notes}</p>` : ''}
                    </div>
                    <h4>Items</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Product Name</th>
                                <th>Quantity</th>
                                <th>Price (₹)</th>
                                <th>Amount (₹)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemDetails.length ? itemDetails.map(item => `
                                <tr>
                                    <td>${item.name}</td>
                                    <td>${item.quantity}</td>
                                    <td>${item.price}</td>
                                    <td>${item.amount}</td>
                                </tr>
                            `).join('') : '<tr><td colspan="4">No items found</td></tr>'}
                        </tbody>
                    </table>
                    ${order.status === 'Processing' || order.status === 'Shipped' ? `
                        <div class="btn-container">
                            <button class="btn btn-primary" onclick="cancelOrder(${order.id})" aria-label="Cancel order ${order.id}">Cancel Order</button>
                        </div>
                    ` : ''}
                </div>
            `;
            document.getElementById('orderDetailsModal').style.display = 'flex';
            document.querySelector('.order-details-container').focus();
        }

        function cancelOrder(orderId) {
            if (!confirm('Are you sure you want to cancel this order?')) return;
            const order = orders.find(o => o.id === orderId && o.user === currentUser.email);
            if (!order) {
                showNotification('Order not found', 'error');
                return;
            }
            if (order.status === 'Cancelled' || order.status === 'Delivered') {
                showNotification('This order cannot be cancelled', 'error');
                return;
            }
            order.status = 'Cancelled';
            if (order.items) {
                order.items.forEach(item => {
                    const product = products.find(p => p.id === item.id);
                    if (product) product.stock += item.quantity || 0;
                });
            }
            saveData();
            loadOrders();
            loadProducts();
            closeOrderDetails();
            showNotification('Order cancelled successfully', 'success');
        }

        function closeOrderDetails() {
            document.getElementById('orderDetailsModal').style.display = 'none';
            document.getElementById('orderDetailsContent').innerHTML = '';
        }

        // Place Order
        function placeOrder(deliveryDetails) {
            const userCart = cart.filter(item => item.user === currentUser.email && item.productId);
            if (!userCart.length) {
                showNotification('Your cart is empty', 'error');
                return;
            }
            const items = userCart.map(item => {
                const product = products.find(p => p.id === item.productId);
                if (!product || product.stock < item.quantity) {
                    showNotification(`Insufficient stock for ${product ? product.name : 'item'}`, 'error');
                    return null;
                }
                product.stock -= item.quantity;
                return { id: item.productId, quantity: item.quantity, price: product.discountedPrice || product.mrpPrice || 0 };
            }).filter(item => item);
            if (items.length !== userCart.length) {
                loadProducts();
                loadCart();
                return;
            }
            const subtotal = items.reduce((sum, item) => sum + item.price * item.quantity, 0);
            const appliedCoupon = cart.find(item => item.user === currentUser.email && item.coupon);
            let discount = 0;
            let couponCode = null;
            let discountPercentage = null;
            if (appliedCoupon) {
                const coupon = coupons.find(c => c.code === appliedCoupon.coupon);
                if (coupon) {
                    discount = subtotal * coupon.discount;
                    couponCode = coupon.code;
                    discountPercentage = coupon.discount;
                }
            }
            const total = subtotal - discount;
            if (total < 0) {
                showNotification('Invalid total amount', 'error');
                return;
            }
            const order = {
                id: orders.length ? Math.max(...orders.map(o => o.id)) + 1 : 1,
                user: currentUser.email,
                date: new Date().toISOString(),
                subtotal,
                discountAmount: discount,
                coupon: couponCode,
                discountPercentage,
                total,
                status: 'Processing',
                items,
                deliveryDetails,
                isNew: true
            };
            orders.push(order);
            cart = cart.filter(item => item.user !== currentUser.email || item.coupon);
            saveData();
            loadProducts();
            loadCart();
            loadOrders();
            showNotification(`Order #${order.id} placed successfully`, 'success');
        }

        // Profile Section
        function loadProfile() {
            const user = users.find(u => u.email === currentUser.email);
            if (!user) {
                showNotification('User not found', 'error');
                logout();
                return;
            }
            document.getElementById('profileUsername').value = user.username || '';
            document.getElementById('profileEmail').value = user.email || '';
            document.getElementById('profilePhone').value = user.phone || '';
            document.getElementById('profileAddress').value = user.address || '';
            document.querySelectorAll('.form-group .error').forEach(error => error.textContent = '');
        }

        document.getElementById('profileForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('profileUsername').value.trim();
            const phone = document.getElementById('profilePhone').value.trim();
            const address = document.getElementById('profileAddress').value.trim();

            const usernameError = document.getElementById('profileUsernameError');
            const phoneError = document.getElementById('profilePhoneError');
            const addressError = document.getElementById('profileAddressError');
            document.querySelectorAll('.form-group .error').forEach(error => error.textContent = '');

            let hasError = false;
            if (username.length < 2) {
                usernameError.textContent = 'Username must be at least 2 characters';
                hasError = true;
            }
            if (!/^\+?\d{10,15}$/.test(phone)) {
                phoneError.textContent = 'Invalid phone number';
                hasError = true;
            }
            if (address.length < 5) {
                addressError.textContent = 'Address must be at least 5 characters';
                hasError = true;
            }

            if (hasError) {
                showNotification('Please fix the errors in the form', 'error');
                return;
            }

            const user = users.find(u => u.email === currentUser.email);
            if (user) {
                user.username = username;
                user.phone = phone;
                user.address = address;
                currentUser.username = username;
                saveData();
                showNotification('Profile updated successfully', 'success');
            } else {
                showNotification('User not found', 'error');
                logout();
            }
        });

        // Product Details Modal
        let currentImageIndex = 0;
        function viewProductDetails(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) {
                showNotification('Product not found', 'error');
                return;
            }
            currentImageIndex = 0;
            const images = product.images && product.images.length ? product.images : ['https://via.placeholder.com/300'];
            const content = document.getElementById('productDetailsContent');
            content.innerHTML = `
                <div class="product-details-container">
                    <div class="product-carousel">
                        <div class="carousel-images" style="transform: translateX(0);">
                            ${images.map(img => `<img src="${img}" alt="Product Image" aria-hidden="true">`).join('')}
                        </div>
                        ${images.length > 1 ? `
                            <button class="carousel-arrow left" onclick="prevImage(${images.length})" aria-label="Previous Image"><i class="fas fa-chevron-left"></i></button>
                            <button class="carousel-arrow right" onclick="nextImage(${images.length})" aria-label="Next Image"><i class="fas fa-chevron-right"></i></button>
                            <div class="carousel-dots">
                                ${images.map((_, i) => `<span class="carousel-dot ${i === 0 ? 'active' : ''}" onclick="showImage(${i}, ${images.length})" aria-label="Go to image ${i + 1}"></span>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                    <div class="product-details">
                        <h3>${product.name || 'Unknown'}</h3>
                        <p><strong>Category:</strong> ${product.category || 'Unknown'}</p>
                        <p><strong>Price:</strong> ₹${(product.mrpPrice || 0).toFixed(2)}</p>
                        ${product.discountedPrice ? `<p><strong>Discounted Price:</strong> ₹${product.discountedPrice.toFixed(2)}</p>` : ''}
                        <p><strong>Stock:</strong> ${product.stock !== undefined ? product.stock : 'Unknown'}</p>
                        <p><strong>Description:</strong> ${product.description || 'No description'}</p>
                    </div>
                </div>
            `;
            document.getElementById('productDetailsModal').style.display = 'flex';
            document.querySelector('.product-details-container').focus();
        }

        function showImage(index, totalImages) {
            currentImageIndex = index;
            const carousel = document.querySelector('.carousel-images');
            carousel.style.transform = `translateX(-${index * 100}%)`;
            document.querySelectorAll('.carousel-dot').forEach((dot, i) => {
                dot.classList.toggle('active', i === index);
            });
        }

        function nextImage(totalImages) {
            currentImageIndex = (currentImageIndex + 1) % totalImages;
            showImage(currentImageIndex, totalImages);
        }

        function prevImage(totalImages) {
            currentImageIndex = (currentImageIndex - 1 + totalImages) % totalImages;
            showImage(currentImageIndex, totalImages);
        }

        function closeProductDetails() {
            document.getElementById('productDetailsModal').style.display = 'none';
            document.getElementById('productDetailsContent').innerHTML = '';
        }

        // Logout
        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            saveData();
            window.location.href = 'login.html';
        }

        // Modal Accessibility
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (modal.id === 'productDetailsModal') closeProductDetails();
                    else if (modal.id === 'orderDetailsModal') closeOrderDetails();
                    else if (modal.id === 'deliveryDetailsModal') closeDeliveryForm();
                }
            });
        });

        // Initialize
        if (!currentUser) {
            window.location.href = 'login.html';
        } else {
            toggleSection('homeSection');
        }

        let searchTimeout;
        document.getElementById('searchProducts').addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(loadProducts, 300);
        });
        document.getElementById('sortProducts').addEventListener('change', loadProducts);
    </script>
</body>
</html>